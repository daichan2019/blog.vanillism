---
title: Auth.js(NextAuth)をNext.js ver13 App Routerで試す
slug: next-auth-with-app-router
publishedAt: 2023-05-07
tags: [Next.js]
---

## プロジェクトディレクトリ作成

Next.js の App Router が ver13.4,1 から stable になりました。
いよいよ、App Router について本格的にキャッチアップしていく必要がありますね。<br />
同時に最近、Auth.js に名を変えた NextAuth も以前から試してみたいと考えていて、せっかくなので App Router で試してみることにしました。
App Router で Auth.js を解説している記事はまだ少ないので、参考になれば幸いです。
API Route も Route Handler で実装していきます。

## 前提条件

- Next.js ver13.4.1
- NextAuth ver4.22.1
- Google 認証のみ解説します

## API Routes の作成

pages ディレクトリ時代は`pages/api/auth/[...nextauth].ts`に記載していましたが、
Route Handler を使用する場合、`app/api/auth/[…nextauth]/route.ts`に以下を記述。

公式では[こちら](https://next-auth.js.org/configuration/initialization#route-handlers-app)で解説しています。

```tsx
import NextAuth from 'next-auth';
import GoogleProvider from 'next-auth/providers/google';

export const authOptions = {
  providers: [
    GoogleProvider({
      clientId: process.env.GOOGLE_CLIENT_ID || '',
      clientSecret: process.env.GOOGLE_CLIENT_SECRET || '',
    }),
  ],
  pages: {
    signIn: '/login',
  },
};

const handler = NextAuth(authOptions);

export { handler as GET, handler as POST };
```

## 環境変数の設定

環境変数の`GOOGLECLIENTID`と`GOOGLE_CLIENT_SECRET`は、Google Developer Console から取得してください。
こちらの記事では取得の方法はスキップします。
`NEXTAUTH_URL`は本番環境へ上げるときは、本番環境のドメインを設定するようにしましょう。

開発時は、`localhost:3000`とします。

```
NEXTAUTH_URL=http://localhost:3000

GOOGLE_CLIENT_ID=
GOOGLE_CLIENT_SECRET=
```

## Component の作成

### Session Provider

Session を監視するために、アプリ全体をラップする Provider コンポーネントを作成します。
クライアントサイドで session を監視するための `useSessionHooks` を使用するために、`use client`を宣言します。

components/session-provider/index.tsx

```tsx
'use client';

import { SessionProvider as NextAuthSessionProvider } from 'next-auth/react';

export type SessionProviderProps = {
  children: JSX.Element;
};

export default function SessionProvider({ children }: SessionProviderProps) {
  return <NextAuthSessionProvider>{children}</NextAuthSessionProvider>;
}
```

また、`app/layout.tsx`に`SessionProvider`を追記して、アプリ全体をラップするようにします。
App Router では、アプリ全体の共通処理は`_app.tsx` ではなく、`app/layout.tsx` に記載します。

```tsx
import SessionProvider from '@/components/session-provider';
import './globals.css';
import { Inter } from 'next/font/google';

const inter = Inter({ subsets: ['latin'] });

export const metadata = {
  title: 'Create Next App',
  description: 'Generated by create next app',
};

export default function RootLayout({ children }: { children: React.ReactNode }) {
  return (
    <html lang='en'>
      <SessionProvider>
        <body className={inter.className}>{children}</body>
      </SessionProvider>
    </html>
  );
}
```

### ログインボタン

`components/google-login-button/index.tsx`を追加

```tsx
'use client';

import { signIn } from 'next-auth/react';

export type GoogleLoginButtonProps = {
  children: JSX.Element | string;
};

export default function GoogleLoginButton({ children }: GoogleLoginButtonProps) {
  return <button onClick={() => signIn('google')}>{children}</button>;
}
```

### ログアウトボタン

```tsx
'use client';

import { signOut } from 'next-auth/react';

export type LogoutButtonProps = {
  children: JSX.Element | string;
};

export default function LogoutButton({ children }: LogoutButtonProps) {
  return <button onClick={() => signOut()}>{children}</button>;
}
```

### ログインページ

`app/login/page.tsx`を以下のようにする。

`getServerSession` で session を取得し、すでにログイン済みだったら、ログインページからトップページへ redirect する処理もここで書きます。

```tsx
import GoogleLoginButton from '@/components/google-login-button';
import { getServerSession } from 'next-auth';
import { redirect } from 'next/navigation';
import { authOptions } from '../api/auth/[...nextauth]/route';

export default async function Page() {
  const session = await getServerSession(authOptions);

  if (session) {
    redirect('/');
  }

  return (
    <div>
      <GoogleLoginButton>Google でログインする</GoogleLoginButton>
    </div>
  );
}
```

### トップページ

`app/page.tsx`

ログインページの逆で、ログインしていなかった場合、ログインページへ redirect するようにしています。

```tsx
import LogoutButton from '@/components/logout-button';
import { getServerSession } from 'next-auth';
import { redirect } from 'next/navigation';
import { authOptions } from './api/auth/[...nextauth]/route';

export default async function Home() {
  const session = await getServerSession(authOptions);

  if (!session) {
    redirect('/login');
  }

  return (
    <main className='flex min-h-screen flex-col items-center justify-between p-24'>
      <pre>{JSON.stringify(session?.user)}</pre>
      {session ? <LogoutButton>ログアウトする</LogoutButton> : null}
    </main>
  );
}
```

上記の実装で、ログイン後、トップページへ遷移し、ログインページへはアクセスできないようになります。逆に、ログインしていない状態では、ログイン後アクセス可能なトップページへはアクセスできず、ログインページへリダイレクトされることになります。

このような Protected Routes の実装は、middleware もしくは layout コンポーネントを使用して実装することもできそうです。
